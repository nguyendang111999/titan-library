<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Titan Library</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <h1>ðŸ“š Titan Library - Admin</h1>
        </div>
        <nav>
          <ul class="nav-links">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="users.html">Users</a></li>
            <li><a href="books.html">Books</a></li>
            <li><a href="borrow-requests.html">Requests</a></li>
          </ul>
        </nav>
        <div class="user-info">
          <span id="adminName">Admin</span>
          <button class="btn btn-secondary" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-header">
        <h1>Dashboard</h1>
        <p>Welcome to the admin dashboard</p>
      </div>

      <div class="admin-dashboard">
        <div class="dashboard-card">
          <h3>Total Books</h3>
          <div class="number" id="totalBooks">0</div>
          <p>Books in library</p>
        </div>
        
        <div class="dashboard-card success">
          <h3>Available Books</h3>
          <div class="number" id="availableBooks">0</div>
          <p>Ready to borrow</p>
        </div>
        
        <div class="dashboard-card warning">
          <h3>Pending Requests</h3>
          <div class="number" id="pendingRequests">0</div>
          <p>Awaiting approval</p>
        </div>
        
        <div class="dashboard-card danger">
          <h3>Total Users</h3>
          <div class="number" id="totalUsers">0</div>
          <p>Registered members</p>
        </div>
      </div>

      <div class="card mt-2">
        <div class="card-header">
          <h3>Recent Activities</h3>
        </div>
        <div id="recentActivities">
          <div class="loading show">
            <div class="spinner"></div>
            <p>Loading activities...</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3>Quick Actions</h3>
        </div>
        <div class="quick-actions">
          <a href="users.html" class="btn btn-primary">Manage Users</a>
          <a href="books.html" class="btn btn-primary">Manage Books</a>
          <a href="borrow-requests.html" class="btn btn-warning">View Requests</a>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { checkAuth, logout } from '../js/auth.js';
    import { database } from '../js/firebase-config.js';
    import { ref, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    let currentUser = null;

    // Check authentication
    checkAuth('admin').then(({ user, userData }) => {
      currentUser = user;
      document.getElementById('adminName').textContent = userData.username || userData.email;
      loadDashboardData();
    }).catch((error) => {
      console.error('Auth error:', error);
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', logout);

    async function loadDashboardData() {
      try {
        // Load total books
        const booksRef = ref(database, 'books');
        const booksSnapshot = await get(booksRef);
        
        let totalBooks = 0;
        let availableBooks = 0;
        
        if (booksSnapshot.exists()) {
          const books = booksSnapshot.val();
          totalBooks = Object.keys(books).length;
          
          Object.values(books).forEach(book => {
            availableBooks += book.availableCopies || 0;
          });
        }
        
        document.getElementById('totalBooks').textContent = totalBooks;
        document.getElementById('availableBooks').textContent = availableBooks;
        
        // Load total users
        const usersRef = ref(database, 'users');
        const usersSnapshot = await get(usersRef);
        
        let totalUsers = 0;
        if (usersSnapshot.exists()) {
          const users = usersSnapshot.val();
          totalUsers = Object.values(users).filter(u => u.role === 'user').length;
        }
        
        document.getElementById('totalUsers').textContent = totalUsers;
        
        // Load pending requests
        const borrowsRef = ref(database, 'borrowRecords');
        const borrowsSnapshot = await get(borrowsRef);
        
        let pendingRequests = 0;
        if (borrowsSnapshot.exists()) {
          const borrows = borrowsSnapshot.val();
          pendingRequests = Object.values(borrows).filter(
            b => b.status === 'pending_borrow' || b.status === 'pending_return'
          ).length;
        }
        
        document.getElementById('pendingRequests').textContent = pendingRequests;
        
        // Load recent activities
        loadRecentActivities(borrowsSnapshot.val());
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    function loadRecentActivities(borrows) {
      const activitiesDiv = document.getElementById('recentActivities');
      activitiesDiv.innerHTML = '';
      
      if (!borrows) {
        activitiesDiv.innerHTML = '<p style="color: var(--secondary-color); text-align: center;">No activities yet</p>';
        return;
      }
      
      const borrowArray = Object.entries(borrows)
        .map(([id, data]) => ({ id, ...data }))
        .sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate))
        .slice(0, 10);
      
      if (borrowArray.length === 0) {
        activitiesDiv.innerHTML = '<p style="color: var(--secondary-color); text-align: center;">No activities yet</p>';
        return;
      }
      
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>User</th>
            <th>Book</th>
            <th>Action</th>
            <th>Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${borrowArray.map(activity => `
            <tr>
              <td>${activity.userName}</td>
              <td>${activity.bookTitle}</td>
              <td>${activity.status.includes('borrow') ? 'Borrow' : 'Return'}</td>
              <td>${new Date(activity.borrowDate).toLocaleDateString()}</td>
              <td><span class="badge badge-${getStatusBadge(activity.status)}">${formatStatus(activity.status)}</span></td>
            </tr>
          `).join('')}
        </tbody>
      `;
      
      activitiesDiv.appendChild(table);
    }

    function getStatusBadge(status) {
      const badges = {
        'pending_borrow': 'warning',
        'borrowed': 'info',
        'pending_return': 'warning',
        'returned': 'success'
      };
      return badges[status] || 'info';
    }

    function formatStatus(status) {
      return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }
  </script>
</body>
</html>
